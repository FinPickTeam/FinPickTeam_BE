<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.scoula.avatar.mapper.AvatarMapper">

    <!-- 아바타 생성 -->
    <insert id="insertAvatar">
        INSERT INTO avatar (id,level_id) VALUES (#{userId}, 1) <!-- 기본 아바타 이미지 삽입 -->
    </insert>

    <!--아바타 착장 조회-->
    <select id="getAvatar" resultType="org.scoula.avatar.domain.AvatarVO">
        SELECT id AS userId, level_id, top_id, shoes_id, accessory_id, gift_card_id
        FROM avatar WHERE id=#{userId}
    </select>

    <!--아이템 타입 조회-->
    <select id="getItemType" parameterType="Long" resultType="String">
        SELECT type FROM item WHERE id=#{itemId}
    </select>

    <!--아바타 착장 수정-->
    <update id="updateAvatar" parameterType="org.scoula.avatar.domain.AvatarVO">
        UPDATE avatar
        SET
            level_id=#{levelId},
            top_id = #{topId},
            shoes_id = #{shoesId},
            accessory_id = #{accessoryId},
            gift_card_id = #{giftCardId}
        WHERE
            id = #{userId}
    </update>

    <!--아바타 착장 아이템 1개만 수정-->
    <update id="updateAvatarByItemId">
            UPDATE avatar
            SET
                ${type}_id=#{itemId}
            WHERE
                id=#{userId}
    </update>

    <!-- clothes의 is_Wearing 컬럼 한번에 수정-->
    <update id="updateClothe">
        UPDATE `clothes` SET `is_wearing` = #{isWearing} WHERE `user_id` = #{userId} AND `item_id` IN
        <foreach collection="items" item="itemId" open="(" separator="," close=")">
            #{itemId}
        </foreach>;
    </update>

    <!-- clothes의 is_Wearing 컬럼 1개만 수정-->
    <update id="updateClotheByItemId">
        UPDATE `clothes` SET `is_wearing`=#{isWearing} where `user_id`= #{userId} and `item_id`=#{itemId}
    </update>

    <update id="unequipAllItems">
        UPDATE `avatar`
        SET top_id = NULL,
            shoes_id = NULL,
            accessory_id =NULL,
            gift_card_id = NULL
        WHERE
            id = #{userId}
    </update>

    <!-- 전체 의상 목록 조회 -->
    <select id="getUserClothes" resultType="org.scoula.avatar.domain.UserClothesVO">
        SELECT
            i.id as itemID,
            i.name,
            i.type,
            i.cost,
            i.image_url,
            c.is_wearing,
            c.id IS NOT NULL AS is_owned
        FROM
            item i
                LEFT JOIN
            clothes c ON i.id = c.item_id AND c.user_id = #{userId};
    </select>


    <!-- 옷장에 유저의상 추가 -->
    <insert id="insertClothe">
        INSERT INTO clothes (user_id, item_id, is_wearing)VALUES (#{userId}, #{itemId}, false)
    </insert>


    <!-- 아이템 정보 조회 -->
    <select id="getItem" resultType="org.scoula.avatar.domain.ItemsVO">
        SELECT * FROM item where id=#{itemId}
    </select>

</mapper>