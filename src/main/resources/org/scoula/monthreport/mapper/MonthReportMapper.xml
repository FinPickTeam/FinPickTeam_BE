<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.scoula.monthreport.mapper.MonthReportMapper">

    <!-- 🗓 거래내역 존재하는 월 목록 (ledger 기준) -->
    <select id="findTransactionMonths" resultType="string">
        SELECT DISTINCT DATE_FORMAT(l.date, '%Y-%m') AS month
        FROM ledger l
        WHERE l.user_id = #{userId}
          AND l.source_type = 'CARD'
          AND l.type = 'EXPENSE'
        ORDER BY month ASC
    </select>

    <!-- 📆 이미 생성된 월간 리포트 목록 -->
    <select id="findExistingReportMonths" resultType="string">
        SELECT mr.month
        FROM monthreport mr
        WHERE mr.user_id = #{userId}
        ORDER BY mr.month ASC
    </select>

    <!-- 💳 해당 월 ledger 조회 (활성 계좌/카드만, 카멜 매핑 alias) -->
    <select id="findLedgerTransactions"
            resultType="org.scoula.monthreport.domain.LedgerTransaction">
        SELECT
            l.amount        AS amount,
            c.label         AS categoryName,
            l.source_type   AS sourceType,
            l.account_id    AS accountId,
            l.card_id       AS cardId,
            l.date          AS date
        FROM ledger l
                 JOIN tr_category c ON l.category_id = c.id
                 LEFT JOIN account a ON a.id = l.account_id AND a.user_id = l.user_id
                 LEFT JOIN card    cd ON cd.id = l.card_id   AND cd.user_id = l.user_id
        WHERE l.user_id = #{userId}
          AND l.date BETWEEN #{from} AND #{to}
          AND l.type = 'EXPENSE'
          AND (
            (l.source_type = 'ACCOUNT' AND a.is_active = 1)
                OR (l.source_type = 'CARD'    AND cd.is_active = 1)
            )
    </select>

    <!-- 🔁 전월 리포트 조회 -->
    <select id="findMonthReport" resultType="org.scoula.monthreport.domain.MonthReport">
        SELECT mr.*
        FROM monthreport mr
        WHERE mr.user_id = #{userId}
          AND mr.month = #{month}
        LIMIT 1
    </select>

    <!-- 📈 최근 6개월 리포트 (현재 월 포함 요청 전용) -->
    <select id="findRecentMonthReportsInclusive"
            resultType="org.scoula.monthreport.domain.MonthReport">
        SELECT mr.month, mr.total_expense
        FROM monthreport mr
        WHERE mr.user_id = #{userId}
          AND mr.month &lt;= #{currentMonth}
        ORDER BY mr.month DESC
        LIMIT #{limit}
    </select>

    <!-- 🧾 월간 리포트 저장 -->
    <insert id="insertMonthReport">
        INSERT INTO monthreport (
            user_id, month, total_expense, total_saving, saving_rate,
            compare_expense, compare_saving, category_chart, six_month_chart,
            pattern_label, feedback, next_goal
        ) VALUES (
                     #{userId}, #{month}, #{totalExpense}, #{totalSaving}, #{savingRate},
                     #{compareExpense}, #{compareSaving}, #{categoryChart}, #{sixMonthChart},
                     #{patternLabel}, #{feedback}, #{nextGoal}
                 )
    </insert>

    <!-- 👥 카드 거래 보유 사용자 -->
    <select id="findUsersWithCardTransactions" resultType="long">
        SELECT DISTINCT l.user_id
        FROM ledger l
        WHERE l.source_type = 'CARD'
          AND l.type = 'EXPENSE'
    </select>

    <!-- src/main/resources/mappers/MonthReportMapper.xml -->
    <resultMap id="TxLedgerMap" type="org.scoula.transactions.domain.Ledger">
        <result property="userId"       column="user_id"/>
        <result property="type"         column="type"/>
        <result property="amount"       column="amount"/>
        <result property="category"     column="category"/>
        <result property="date"         column="date"/>
        <result property="merchantName" column="merchant_name"/>
    </resultMap>

    <select id="findExpenseLedgersForReport" resultMap="TxLedgerMap">
        SELECT
        l.user_id            AS user_id,
        l.type               AS type,               -- 'EXPENSE'로 필터하지만 필드에도 그대로 매핑
        l.amount             AS amount,
        tc.label              AS category,           -- ✅ 엔진이 쓰는 '표준 카테고리 키'를 바로 주자
        l.date               AS date,
        l.merchant_name      AS merchant_name
        FROM ledger l
        JOIN tr_category tc ON tc.id = l.category_id
        WHERE l.user_id = #{userId}
        AND l.type = 'EXPENSE'
        AND l.date >= #{from}
        AND l.date &lt;  #{to} + INTERVAL 1 DAY
    </select>


</mapper>
