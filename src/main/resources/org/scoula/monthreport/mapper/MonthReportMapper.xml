<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.scoula.monthreport.mapper.MonthReportMapper">

    <!-- ðŸ—“ ê±°ëž˜ë‚´ì—­ ì¡´ìž¬í•˜ëŠ” ì›” ëª©ë¡ (ledger ê¸°ì¤€) -->
    <select id="findTransactionMonths" resultType="string">
        SELECT DISTINCT DATE_FORMAT(l.date, '%Y-%m') AS month
        FROM ledger l
        WHERE l.user_id = #{userId}
          AND l.source_type = 'CARD'
          AND l.type = 'EXPENSE'
        ORDER BY month ASC
    </select>

    <!-- ðŸ“† ì´ë¯¸ ìƒì„±ëœ ì›”ê°„ ë¦¬í¬íŠ¸ ëª©ë¡ -->
    <select id="findExistingReportMonths" resultType="string">
        SELECT mr.month
        FROM monthreport mr
        WHERE mr.user_id = #{userId}
        ORDER BY mr.month ASC
    </select>

    <!-- ðŸ’³ í•´ë‹¹ ì›” ledger ì¡°íšŒ (í™œì„± ê³„ì¢Œ/ì¹´ë“œë§Œ, ì¹´ë©œ ë§¤í•‘ alias) -->
    <select id="findLedgerTransactions"
            resultType="org.scoula.monthreport.domain.LedgerTransaction">
        SELECT
            l.amount        AS amount,
            c.label         AS categoryName,
            l.source_type   AS sourceType,
            l.account_id    AS accountId,
            l.card_id       AS cardId,
            l.date          AS date
        FROM ledger l
                 JOIN tr_category c ON l.category_id = c.id
                 LEFT JOIN account a ON a.id = l.account_id AND a.user_id = l.user_id
                 LEFT JOIN card    cd ON cd.id = l.card_id   AND cd.user_id = l.user_id
        WHERE l.user_id = #{userId}
          AND l.date BETWEEN #{from} AND #{to}
          AND l.type = 'EXPENSE'
          AND (
            (l.source_type = 'ACCOUNT' AND a.is_active = 1)
                OR (l.source_type = 'CARD'    AND cd.is_active = 1)
            )
    </select>

    <!-- ðŸ” ì „ì›” ë¦¬í¬íŠ¸ ì¡°íšŒ -->
    <select id="findMonthReport" resultType="org.scoula.monthreport.domain.MonthReport">
        SELECT mr.*
        FROM monthreport mr
        WHERE mr.user_id = #{userId}
          AND mr.month = #{month}
        LIMIT 1
    </select>

    <!-- ðŸ“ˆ ìµœê·¼ 6ê°œì›” ë¦¬í¬íŠ¸ (í˜„ìž¬ ì›” í¬í•¨ ìš”ì²­ ì „ìš©) -->
    <select id="findRecentMonthReportsInclusive"
            resultType="org.scoula.monthreport.domain.MonthReport">
        SELECT mr.month, mr.total_expense
        FROM monthreport mr
        WHERE mr.user_id = #{userId}
          AND mr.month &lt;= #{currentMonth}
        ORDER BY mr.month DESC
        LIMIT #{limit}
    </select>

    <!-- ðŸ§¾ ì›”ê°„ ë¦¬í¬íŠ¸ ì €ìž¥ -->
    <insert id="insertMonthReport">
        INSERT INTO monthreport (
            user_id, month, total_expense, total_saving, saving_rate,
            compare_expense, compare_saving, category_chart, six_month_chart,
            feedback, next_goal
        ) VALUES (
                     #{userId}, #{month}, #{totalExpense}, #{totalSaving}, #{savingRate},
                     #{compareExpense}, #{compareSaving}, #{categoryChart}, #{sixMonthChart},
                     #{feedback}, #{nextGoal}
                 )
    </insert>

    <!-- ðŸ‘¥ ì¹´ë“œ ê±°ëž˜ ë³´ìœ  ì‚¬ìš©ìž -->
    <select id="findUsersWithCardTransactions" resultType="long">
        SELECT DISTINCT l.user_id
        FROM ledger l
        WHERE l.source_type = 'CARD'
          AND l.type = 'EXPENSE'
    </select>

</mapper>
